{{template "app-deps"}}

<link rel="stylesheet" href="{{host}}/public/styles/markdown.css">

<!-- PWA Support -->
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#1d232a">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Skyscape">
<link rel="apple-touch-icon" href="/public/logo.svg">

<script>
// Register service worker with auto-update
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js', { scope: '/' })
      .then((registration) => {
        console.log('[PWA] Service Worker registered:', registration.scope);

        // Check for updates immediately and every 60 seconds
        registration.update();
        setInterval(() => registration.update(), 60000);

        // Listen for new service worker
        registration.addEventListener('updatefound', () => {
          const newWorker = registration.installing;
          console.log('[PWA] New Service Worker installing...');

          newWorker.addEventListener('statechange', () => {
            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
              console.log('[PWA] New version available, reloading...');
              window.location.reload();
            }
          });
        });
      })
      .catch((error) => {
        console.error('[PWA] Service Worker registration failed:', error);
      });
  });

  // Reload when new service worker takes control
  navigator.serviceWorker.addEventListener('controllerchange', () => {
    console.log('[PWA] Controller changed, reloading...');
    window.location.reload();
  });
}

// PWA Install Prompt
window.Skyscape = window.Skyscape || {};
window.Skyscape.deferredPrompt = null;
window.Skyscape.isInstalled = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;

// Capture install prompt event (Chrome/Edge/Android)
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  window.Skyscape.deferredPrompt = e;
  if (!window.Skyscape.isInstalled && !localStorage.getItem('pwa-dismissed')) {
    showInstallBanner();
  }
});

// Detect iOS
const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

// Show install banner on iOS if not installed
if (isIOS && !window.Skyscape.isInstalled && !localStorage.getItem('pwa-dismissed')) {
  window.addEventListener('load', () => setTimeout(showIOSInstallBanner, 2000));
}

function showInstallBanner() {
  if (document.getElementById('pwa-install-banner')) return;

  const banner = document.createElement('div');
  banner.id = 'pwa-install-banner';
  banner.className = 'fixed bottom-20 md:bottom-4 left-4 right-4 md:left-auto md:right-4 md:w-80 bg-base-100 border border-base-300 rounded-xl shadow-xl p-4 z-50';
  banner.innerHTML = `
    <div class="flex items-start gap-3">
      <img src="/public/logo.svg" class="w-12 h-12 rounded-lg" alt="Skyscape">
      <div class="flex-1 min-w-0">
        <h3 class="font-bold text-sm">Install Skyscape</h3>
        <p class="text-xs opacity-70">Add to your home screen for quick access</p>
      </div>
      <button onclick="dismissInstallBanner()" class="btn btn-ghost btn-xs btn-circle">✕</button>
    </div>
    <div class="flex gap-2 mt-3">
      <button onclick="installPWA()" class="btn btn-primary btn-sm flex-1">Install</button>
      <button onclick="dismissInstallBanner()" class="btn btn-ghost btn-sm">Not now</button>
    </div>
  `;
  document.body.appendChild(banner);
}

function showIOSInstallBanner() {
  if (document.getElementById('pwa-install-banner')) return;

  const banner = document.createElement('div');
  banner.id = 'pwa-install-banner';
  banner.className = 'fixed bottom-20 md:bottom-4 left-4 right-4 md:left-auto md:right-4 md:w-80 bg-base-100 border border-base-300 rounded-xl shadow-xl p-4 z-50';
  banner.innerHTML = `
    <div class="flex items-start gap-3">
      <img src="/public/logo.svg" class="w-12 h-12 rounded-lg" alt="Skyscape">
      <div class="flex-1 min-w-0">
        <h3 class="font-bold text-sm">Install Skyscape</h3>
        <p class="text-xs opacity-70">Add to your home screen for quick access</p>
      </div>
      <button onclick="dismissInstallBanner()" class="btn btn-ghost btn-xs btn-circle">✕</button>
    </div>
    <div class="mt-3 space-y-2">
      <div class="flex items-center gap-3 text-sm">
        <span class="badge badge-primary badge-sm">1</span>
        <span>Tap <svg class="w-5 h-5 inline text-primary" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 8.25H7.5a2.25 2.25 0 00-2.25 2.25v9a2.25 2.25 0 002.25 2.25h9a2.25 2.25 0 002.25-2.25v-9a2.25 2.25 0 00-2.25-2.25H15m0-3l-3-3m0 0l-3 3m3-3V15" /></svg> in Safari toolbar below</span>
      </div>
      <div class="flex items-center gap-3 text-sm">
        <span class="badge badge-primary badge-sm">2</span>
        <span>Scroll and tap <strong>"Add to Home Screen"</strong></span>
      </div>
    </div>
    <button onclick="dismissInstallBanner()" class="btn btn-ghost btn-sm btn-block mt-3">Maybe later</button>
  `;
  document.body.appendChild(banner);

  // Add a pulsing indicator pointing to Safari's share button
  const indicator = document.createElement('div');
  indicator.id = 'pwa-share-indicator';
  indicator.className = 'fixed bottom-2 left-1/2 -translate-x-1/2 z-50';
  indicator.innerHTML = `
    <div class="animate-bounce text-primary">
      <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24"><path d="M12 16l-6-6h12l-6 6z"/></svg>
    </div>
  `;
  document.body.appendChild(indicator);
}

function installPWA() {
  if (window.Skyscape.deferredPrompt) {
    window.Skyscape.deferredPrompt.prompt();
    window.Skyscape.deferredPrompt.userChoice.then((result) => {
      if (result.outcome === 'accepted') {
        console.log('[PWA] App installed');
      }
      window.Skyscape.deferredPrompt = null;
      dismissInstallBanner();
    });
  }
}

function dismissInstallBanner() {
  const banner = document.getElementById('pwa-install-banner');
  if (banner) banner.remove();
  const indicator = document.getElementById('pwa-share-indicator');
  if (indicator) indicator.remove();
  localStorage.setItem('pwa-dismissed', Date.now());
}

// Notification permission helper
window.Skyscape = window.Skyscape || {};
window.Skyscape.requestNotifications = async function() {
  if (!('Notification' in window)) {
    console.warn('[PWA] Notifications not supported');
    return false;
  }

  if (Notification.permission === 'granted') {
    return true;
  }

  if (Notification.permission !== 'denied') {
    const permission = await Notification.requestPermission();
    return permission === 'granted';
  }

  return false;
};

// Subscribe to push notifications
window.Skyscape.subscribeToPush = async function(vapidPublicKey) {
  const registration = await navigator.serviceWorker.ready;

  const subscription = await registration.pushManager.subscribe({
    userVisibleOnly: true,
    applicationServerKey: vapidPublicKey
  });

  return subscription;
};

// Show local notification with sound and vibration
window.Skyscape.notify = async function(title, options = {}) {
  if (Notification.permission !== 'granted') {
    console.warn('[Notifications] Permission not granted');
    return;
  }

  try {
    const registration = await navigator.serviceWorker.ready;
    await registration.showNotification(title, {
      icon: '/public/logo.svg',
      badge: '/public/logo.svg',
      vibrate: [200, 100, 200, 100, 200],
      requireInteraction: true,
      renotify: true,
      silent: false,
      tag: 'skyscape-' + Date.now(),
      ...options
    });
    console.log('[Notifications] Notification shown:', title);
  } catch (err) {
    console.error('[Notifications] Failed to show notification:', err);
  }
};

// Message notification polling - use sessionStorage to persist across page navigations
window.Skyscape.getLastUnreadCount = function() {
  const stored = sessionStorage.getItem('skyscape-last-unread');
  return stored !== null ? parseInt(stored, 10) : -1;
};

window.Skyscape.setLastUnreadCount = function(count) {
  sessionStorage.setItem('skyscape-last-unread', count.toString());
};

window.Skyscape.pollInterval = null;

window.Skyscape.checkNewMessages = async function() {
  // Only poll if notifications are enabled
  if (Notification.permission !== 'granted') return;

  try {
    const resp = await fetch('/api/messages/unread', { credentials: 'same-origin' });
    if (!resp.ok) {
      console.warn('[Notifications] API returned:', resp.status);
      return;
    }

    const data = await resp.json();
    const count = data.count || 0;
    const lastCount = window.Skyscape.getLastUnreadCount();

    console.log('[Notifications] Unread count:', count, 'Last:', lastCount);

    // Show notification if count increased (and not first check)
    if (lastCount >= 0 && count > lastCount) {
      const diff = count - lastCount;
      await window.Skyscape.notify('New Message', {
        body: diff === 1 ? 'You have a new message' : `You have ${diff} new messages`,
        data: { url: '/messages' }
      });
    }

    window.Skyscape.setLastUnreadCount(count);
  } catch (err) {
    console.error('[Notifications] Failed to check messages:', err);
  }
};

// Start/stop polling based on page visibility
window.Skyscape.startMessagePolling = function() {
  if (window.Skyscape.pollInterval) return;
  window.Skyscape.checkNewMessages(); // Check immediately
  window.Skyscape.pollInterval = setInterval(window.Skyscape.checkNewMessages, 10000);
};

window.Skyscape.stopMessagePolling = function() {
  if (window.Skyscape.pollInterval) {
    clearInterval(window.Skyscape.pollInterval);
    window.Skyscape.pollInterval = null;
  }
};

// Handle visibility changes
document.addEventListener('visibilitychange', () => {
  if (document.hidden) {
    window.Skyscape.stopMessagePolling();
  } else {
    window.Skyscape.startMessagePolling();
  }
});

// Start polling on page load if notifications are enabled
window.addEventListener('load', () => {
  if (Notification.permission === 'granted') {
    window.Skyscape.startMessagePolling();
  }
});
</script>