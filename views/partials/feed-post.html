<article class="card bg-base-100/80 backdrop-blur-sm border border-white/5 w-full">
  <div class="card-body gap-3">
    {{with .User}}
    <header class="flex items-center gap-2">
      <div class="w-5 h-5 rounded-full bg-white/10 border border-white/10 p-0.5 shrink-0">
        <img src="{{.Avatar}}" alt="{{.Name}}" class="rounded-full w-full h-full">
      </div>
      <div class="flex items-center gap-2 min-w-0">
        <span class="text-sm font-medium">@{{.Handle}}</span>
        <span class="text-sm text-white/50 capitalize">{{$.Action}}</span>
      </div>

      {{$user := auth.CurrentUser}}
      {{if and $user (eq $user.ID .ID)}}
      <div class="dropdown dropdown-end ml-auto">
        <button tabindex="0" class="btn btn-ghost btn-sm btn-square">
          {{template "icon-dots.html"}}
        </button>
        <ul tabindex="-1" class="dropdown-content menu bg-base-100 rounded-box z-50 w-52 p-2 shadow-sm border border-white/20">
          <li><a hx-confirm="Are you sure you want to delete this post?" hx-delete="{{host}}/feed/{{$.ID}}" class="text-error">Delete</a></li>
        </ul>
      </div>
      {{end}}
    </header>
    {{end}}

    {{if $.Content}}
    <p class="text-base {{if or .Repo .Profile .App .File}}text-white/70{{else}}text-white/90 text-lg{{end}}">
      {{$.Content}}
    </p>
    {{end}}

    {{with $.File}}
    <a href="{{host}}/file/{{.ID}}" target="_blank" class="block rounded-xl overflow-hidden border border-white/10 hover:border-white/20 transition-colors">
      <img src="{{host}}/file/{{.ID}}" alt="Post image" class="w-full max-h-96 object-cover">
    </a>
    {{end}}

    {{if or .Repo .Profile .App}}
    <div class="rounded-xl border border-white/10 overflow-hidden hover:border-white/20 transition-colors" hx-boost="true">
      {{with .Repo}}
      <a href="{{host}}/repo/{{.ID}}" class="flex items-center gap-3 p-4 hover:bg-white/5 transition-colors">
        <div class="flex-1 min-w-0">
          <div class="flex items-center gap-2 mb-1">
            {{with .Owner}}
            <div class="w-5 h-5 rounded-full bg-white/10 border border-white/10 p-0.5 shrink-0">
              <img src="{{.Avatar}}" alt="{{.Name}}" class="rounded-full w-full h-full">
            </div>
            <span class="text-sm text-white/50">@{{.Handle}}</span>
            <span class="text-white/30">/</span>
            {{end}}
            <span class="font-medium truncate">{{.Name}}</span>
          </div>
          <p class="text-sm text-white/50 truncate">{{with .Description}}{{.}}{{else}}<span class="italic">No description</span>{{end}}</p>
        </div>
        {{template "icon-chevron-right.html"}}
      </a>
      {{end}}

      {{with .Profile}}
      <a href="{{host}}/user/{{.Handle}}" class="flex items-center gap-3 p-4 hover:bg-white/5 transition-colors">
        <div class="w-10 h-10 rounded-full bg-white/10 border border-white/10 p-0.5 shrink-0">
          <img src="{{.Avatar}}" alt="{{.Name}}" class="rounded-full w-full h-full">
        </div>
        <div class="flex-1 min-w-0">
          <span class="font-medium block">{{.Name}}</span>
          <p class="text-sm text-white/50 truncate">{{with .Description}}{{.}}{{else}}<span class="italic">No description</span>{{end}}</p>
        </div>
        {{template "icon-chevron-right.html"}}
      </a>
      {{end}}

      {{with .App}}
      <a href="{{host}}/app/{{.ID}}" class="flex items-center gap-3 p-4 hover:bg-white/5 transition-colors">
        <div class="flex-1 min-w-0">
          <div class="flex items-center gap-2 mb-1">
            {{with .Owner}}
            <div class="w-5 h-5 rounded-full bg-white/10 border border-white/10 p-0.5 shrink-0">
              <img src="{{.Avatar}}" alt="{{.Name}}" class="rounded-full w-full h-full">
            </div>
            <span class="text-sm text-white/50">@{{.Handle}}</span>
            <span class="text-white/30">/</span>
            {{end}}
            <span class="font-medium truncate">{{.Name}}</span>
          </div>
          <p class="text-sm text-white/50 truncate">{{with .Description}}{{.}}{{else}}<span class="italic">No description</span>{{end}}</p>
        </div>
        {{template "icon-chevron-right.html"}}
      </a>
      {{end}}
    </div>
    {{end}}

    <!-- Reactions and Comments Section -->
    <footer class="flex flex-col gap-3 pt-2 border-t border-white/5">
      <!-- Reaction Counts Display -->
      {{$reactions := .ReactionCounts}}
      {{if .HasReactions}}
      <div class="flex flex-wrap gap-2">
        {{range $emoji, $count := $reactions}}
        <span class="badge badge-ghost gap-1 text-xs">
          {{if eq $emoji "thumbsup"}}ğŸ‘{{end}}
          {{if eq $emoji "heart"}}â¤ï¸{{end}}
          {{if eq $emoji "tada"}}ğŸ‰{{end}}
          {{if eq $emoji "smile"}}ğŸ˜„{{end}}
          {{if eq $emoji "confused"}}ğŸ˜•{{end}}
          {{if eq $emoji "rocket"}}ğŸš€{{end}}
          {{$count}}
        </span>
        {{end}}
      </div>
      {{end}}

      <!-- Action Bar -->
      {{$user := auth.CurrentUser}}
      {{if $user}}
      <div class="flex items-center gap-2">
        <!-- Reaction Picker -->
        {{$userReaction := .UserReaction $user.ID}}
        <div class="dropdown dropdown-top">
          <button tabindex="0" class="btn btn-ghost btn-sm gap-1">
            {{if $userReaction}}
            {{if eq $userReaction.Emoji "thumbsup"}}ğŸ‘{{end}}
            {{if eq $userReaction.Emoji "heart"}}â¤ï¸{{end}}
            {{if eq $userReaction.Emoji "tada"}}ğŸ‰{{end}}
            {{if eq $userReaction.Emoji "smile"}}ğŸ˜„{{end}}
            {{if eq $userReaction.Emoji "confused"}}ğŸ˜•{{end}}
            {{if eq $userReaction.Emoji "rocket"}}ğŸš€{{end}}
            {{else}}
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15.182 15.182a4.5 4.5 0 01-6.364 0M21 12a9 9 0 11-18 0 9 9 0 0118 0zM9.75 9.75c0 .414-.168.75-.375.75S9 10.164 9 9.75 9.168 9 9.375 9s.375.336.375.75zm-.375 0h.008v.015h-.008V9.75zm5.625 0c0 .414-.168.75-.375.75s-.375-.336-.375-.75.168-.75.375-.75.375.336.375.75zm-.375 0h.008v.015h-.008V9.75z" />
            </svg>
            React
            {{end}}
          </button>
          <div tabindex="0" class="dropdown-content z-50 p-2 shadow-lg bg-base-200 rounded-box border border-white/10">
            <div class="flex gap-1">
              {{$postID := $.ID}}
              <form hx-post="{{host}}/post/{{$postID}}/react" hx-swap="none" class="contents">
                <input type="hidden" name="emoji" value="thumbsup">
                <button type="submit" class="btn btn-ghost btn-sm btn-square hover:bg-white/10">ğŸ‘</button>
              </form>
              <form hx-post="{{host}}/post/{{$postID}}/react" hx-swap="none" class="contents">
                <input type="hidden" name="emoji" value="heart">
                <button type="submit" class="btn btn-ghost btn-sm btn-square hover:bg-white/10">â¤ï¸</button>
              </form>
              <form hx-post="{{host}}/post/{{$postID}}/react" hx-swap="none" class="contents">
                <input type="hidden" name="emoji" value="tada">
                <button type="submit" class="btn btn-ghost btn-sm btn-square hover:bg-white/10">ğŸ‰</button>
              </form>
              <form hx-post="{{host}}/post/{{$postID}}/react" hx-swap="none" class="contents">
                <input type="hidden" name="emoji" value="smile">
                <button type="submit" class="btn btn-ghost btn-sm btn-square hover:bg-white/10">ğŸ˜„</button>
              </form>
              <form hx-post="{{host}}/post/{{$postID}}/react" hx-swap="none" class="contents">
                <input type="hidden" name="emoji" value="confused">
                <button type="submit" class="btn btn-ghost btn-sm btn-square hover:bg-white/10">ğŸ˜•</button>
              </form>
              <form hx-post="{{host}}/post/{{$postID}}/react" hx-swap="none" class="contents">
                <input type="hidden" name="emoji" value="rocket">
                <button type="submit" class="btn btn-ghost btn-sm btn-square hover:bg-white/10">ğŸš€</button>
              </form>
            </div>
            {{if $userReaction}}
            <div class="border-t border-white/10 mt-2 pt-2">
              <form hx-delete="{{host}}/post/{{$postID}}/react" hx-swap="none">
                <button type="submit" class="btn btn-ghost btn-xs btn-block text-error">Remove reaction</button>
              </form>
            </div>
            {{end}}
          </div>
        </div>

        <!-- Comment Toggle Button -->
        <button class="btn btn-ghost btn-sm gap-1" onclick="document.getElementById('comments-{{$.ID}}').classList.toggle('hidden')">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 20.25c4.97 0 9-3.694 9-8.25s-4.03-8.25-9-8.25S3 7.444 3 12c0 2.104.859 4.023 2.273 5.48.432.447.74 1.04.586 1.641a4.483 4.483 0 01-.923 1.785A5.969 5.969 0 006 21c1.282 0 2.47-.402 3.445-1.087.81.22 1.668.337 2.555.337z" />
          </svg>
          {{.CommentsCount}}
        </button>
      </div>
      {{end}}

      <!-- Comments Section (hidden by default) -->
      <div id="comments-{{$.ID}}" class="hidden space-y-3">
        <!-- Existing Comments -->
        {{range .Comments}}
        {{$comment := .}}
        <div class="flex gap-2 pl-2 border-l-2 border-white/10">
          {{with .User}}
          <div class="w-5 h-5 rounded-full bg-white/10 border border-white/10 p-0.5 shrink-0">
            <img src="{{.Avatar}}" alt="{{.Name}}" class="rounded-full w-full h-full">
          </div>
          <div class="flex-1 min-w-0">
            <div class="flex items-center gap-2">
              <span class="text-sm font-medium">@{{.Handle}}</span>
            </div>
            <p class="text-sm text-white/70">{{$comment.Content}}</p>
          </div>
          {{end}}
        </div>
        {{end}}

        <!-- Comment Form -->
        {{if $user}}
        <form hx-post="{{host}}/comment" hx-swap="none" class="flex gap-2">
          <input type="hidden" name="subject_id" value="{{$.ID}}">
          <input type="hidden" name="subject_type" value="post">
          <input type="text" name="content" placeholder="Write a comment..." class="input input-sm input-bordered flex-1 bg-white/5">
          <button type="submit" class="btn btn-sm btn-primary">Post</button>
        </form>
        {{end}}
      </div>
    </footer>
  </div>
</article>