{{$post := .}}
{{$user := auth.CurrentUser}}
{{$postID := .ID}}

<article id="post-{{$postID}}" class="group relative bg-gradient-to-br from-base-100/90 to-base-100/70 backdrop-blur-md rounded-2xl border border-white/[0.08] hover:border-white/[0.15] shadow-lg shadow-black/20 hover:shadow-xl hover:shadow-black/30 transition-all duration-300">

  <!-- Subtle glow effect on hover -->
  <div class="absolute inset-0 rounded-2xl bg-gradient-to-br from-primary/5 via-transparent to-secondary/5 opacity-0 group-hover:opacity-100 transition-opacity duration-500 pointer-events-none"></div>

  <div class="relative p-5">
    <!-- Header -->
    {{with .User}}
    <header class="flex items-start gap-3 mb-4">
      <!-- Avatar -->
      <a href="{{host}}/user/{{.Handle}}" class="shrink-0" hx-boost="true">
        <div class="w-10 h-10 rounded-full bg-white/10 border border-white/10 p-0.5">
          <img src="{{.Avatar}}" alt="{{.Name}}" class="w-full h-full rounded-full object-cover">
        </div>
      </a>

      <div class="flex-1 min-w-0">
        <div class="flex items-center gap-2 flex-wrap">
          <a href="{{host}}/user/{{.Handle}}" class="font-semibold text-white hover:text-primary transition-colors" hx-boost="true">
            @{{.Handle}}
          </a>
          <span class="text-sm text-white/40">{{$post.Action}}</span>
        </div>
        <time class="text-xs text-white/30">{{timeAgo $post.CreatedAt}}</time>
      </div>

      <!-- Actions menu -->
      {{if and $user (eq $user.ID .ID)}}
      <div class="dropdown dropdown-end">
        <button tabindex="0" class="btn btn-ghost btn-sm btn-circle opacity-0 group-hover:opacity-100 transition-opacity">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"/>
          </svg>
        </button>
        <ul tabindex="-1" class="dropdown-content menu bg-base-200 rounded-xl z-50 w-48 p-2 shadow-xl border border-white/10">
          <li>
            <button hx-delete="{{host}}/feed/{{$postID}}" hx-confirm="Delete this post?" hx-target="#post-{{$postID}}" hx-swap="outerHTML swap:0.3s" class="text-error hover:bg-error/20">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
              </svg>
              Delete post
            </button>
          </li>
        </ul>
      </div>
      {{end}}
    </header>
    {{end}}

    <!-- Content -->
    {{if $post.Content}}
    <div class="mb-4">
      <p class="text-[15px] leading-relaxed {{if or .Repo .Profile .App .Thought .File}}text-white/80{{else}}text-white/90 text-base{{end}}">
        {{$post.Content}}
      </p>
    </div>
    {{end}}

    <!-- Image attachment -->
    {{with $post.File}}
    <a href="{{host}}/file/{{.ID}}" target="_blank" class="block mb-4 rounded-xl overflow-hidden border border-white/10 hover:border-primary/30 transition-all duration-300 group/img">
      <div class="relative">
        <img src="{{host}}/file/{{.ID}}" alt="Post image" class="w-full max-h-[400px] object-cover group-hover/img:scale-[1.02] transition-transform duration-500">
        <div class="absolute inset-0 bg-gradient-to-t from-black/20 to-transparent opacity-0 group-hover/img:opacity-100 transition-opacity"></div>
      </div>
    </a>
    {{end}}

    <!-- Embedded content cards -->
    {{if or .Repo .Profile .App .Thought}}
    <div class="mb-4" hx-boost="true">

      {{with .Thought}}
      <a href="{{host}}/thought/{{.ID}}" class="flex items-center gap-4 p-4 rounded-xl bg-accent/5 border border-accent/20 hover:border-accent/40 hover:bg-accent/10 transition-all duration-300 group/card">
        <div class="w-10 h-10 rounded-lg bg-accent/20 flex items-center justify-center shrink-0">
          <svg class="w-5 h-5 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25"/>
          </svg>
        </div>
        <div class="flex-1 min-w-0">
          <div class="flex items-center gap-2 mb-0.5">
            {{with .Profile}}<span class="text-xs text-white/40">@{{.Handle}} /</span>{{end}}
            <span class="font-medium text-white truncate">{{.Title}}</span>
          </div>
          <div class="flex items-center gap-3 text-xs text-white/40">
            <span class="flex items-center gap-1">
              <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
              {{.ViewsCount}}
            </span>
            {{if gt .StarsCount 0}}<span class="text-yellow-400">‚òÖ {{.StarsCount}}</span>{{end}}
          </div>
        </div>
        <svg class="w-5 h-5 text-white/30 group-hover/card:text-accent group-hover/card:translate-x-0.5 transition-all" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
      </a>
      {{end}}

      {{with .Repo}}
      <a href="{{host}}/repo/{{.ID}}" class="flex items-center gap-4 p-4 rounded-xl bg-secondary/5 border border-secondary/20 hover:border-secondary/40 hover:bg-secondary/10 transition-all duration-300 group/card">
        <div class="w-10 h-10 rounded-lg bg-secondary/20 flex items-center justify-center shrink-0">
          <svg class="w-5 h-5 text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M11 21.73a2 2 0 002 0l7-4A2 2 0 0021 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73z M12 22V12 M3.3 7l7.703 4.734a2 2 0 001.994 0L20.7 7"/>
          </svg>
        </div>
        <div class="flex-1 min-w-0">
          <div class="flex items-center gap-2 mb-0.5">
            {{with .Owner}}<span class="text-xs text-white/40">@{{.Handle}} /</span>{{end}}
            <span class="font-medium text-white truncate">{{.Name}}</span>
          </div>
          <p class="text-xs text-white/40 truncate">{{with .Description}}{{.}}{{else}}No description{{end}}</p>
        </div>
        <svg class="w-5 h-5 text-white/30 group-hover/card:text-secondary group-hover/card:translate-x-0.5 transition-all" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
      </a>
      {{end}}

      {{with .App}}
      <a href="{{host}}/app/{{.ID}}" class="flex items-center gap-4 p-4 rounded-xl bg-primary/5 border border-primary/20 hover:border-primary/40 hover:bg-primary/10 transition-all duration-300 group/card">
        <div class="w-10 h-10 rounded-lg bg-primary/20 flex items-center justify-center shrink-0">
          <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
          </svg>
        </div>
        <div class="flex-1 min-w-0">
          <div class="flex items-center gap-2 mb-0.5">
            {{with .Owner}}<span class="text-xs text-white/40">@{{.Handle}} /</span>{{end}}
            <span class="font-medium text-white truncate">{{.Name}}</span>
          </div>
          <p class="text-xs text-white/40 truncate">{{with .Description}}{{.}}{{else}}No description{{end}}</p>
        </div>
        <svg class="w-5 h-5 text-white/30 group-hover/card:text-primary group-hover/card:translate-x-0.5 transition-all" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
      </a>
      {{end}}

      {{with .Profile}}
      <a href="{{host}}/user/{{.Handle}}" class="flex items-center gap-4 p-4 rounded-xl bg-info/5 border border-info/20 hover:border-info/40 hover:bg-info/10 transition-all duration-300 group/card">
        <div class="w-12 h-12 rounded-full bg-white/10 border border-white/10 p-0.5 shrink-0">
          <img src="{{.Avatar}}" alt="{{.Name}}" class="w-full h-full rounded-full object-cover">
        </div>
        <div class="flex-1 min-w-0">
          <span class="font-medium text-white block">{{.Name}}</span>
          <p class="text-xs text-white/40 truncate">{{with .Description}}{{.}}{{else}}No description{{end}}</p>
        </div>
        <svg class="w-5 h-5 text-white/30 group-hover/card:text-info group-hover/card:translate-x-0.5 transition-all" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
      </a>
      {{end}}

    </div>
    {{end}}

    <!-- Engagement bar -->
    <footer class="pt-3 border-t border-white/[0.06]">
      <!-- Reaction display -->
      {{$reactions := .ReactionCounts}}
      {{if .HasReactions}}
      <div class="flex flex-wrap gap-1.5 mb-3">
        {{range $emoji, $count := $reactions}}
        <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-white/5 text-xs hover:bg-white/10 transition-colors cursor-default">
          {{if eq $emoji "thumbsup"}}üëç{{end}}
          {{if eq $emoji "heart"}}‚ù§Ô∏è{{end}}
          {{if eq $emoji "tada"}}üéâ{{end}}
          {{if eq $emoji "smile"}}üòÑ{{end}}
          {{if eq $emoji "confused"}}üòï{{end}}
          {{if eq $emoji "rocket"}}üöÄ{{end}}
          <span class="text-white/60">{{$count}}</span>
        </span>
        {{end}}
      </div>
      {{end}}

      <!-- Action buttons -->
      {{if $user}}
      <div class="flex items-center gap-1">
        <!-- Reaction picker -->
        {{$userReaction := .UserReaction $user.ID}}
        <div class="dropdown dropdown-top">
          <button tabindex="0" class="btn btn-ghost btn-sm gap-2 text-white/50 hover:text-white hover:bg-white/5">
            {{if $userReaction}}
              <span class="text-base">
                {{if eq $userReaction.Emoji "thumbsup"}}üëç{{end}}
                {{if eq $userReaction.Emoji "heart"}}‚ù§Ô∏è{{end}}
                {{if eq $userReaction.Emoji "tada"}}üéâ{{end}}
                {{if eq $userReaction.Emoji "smile"}}üòÑ{{end}}
                {{if eq $userReaction.Emoji "confused"}}üòï{{end}}
                {{if eq $userReaction.Emoji "rocket"}}üöÄ{{end}}
              </span>
            {{else}}
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              <span class="text-xs">React</span>
            {{end}}
          </button>
          <div tabindex="0" class="dropdown-content z-50 mb-2 p-2 bg-base-200/95 backdrop-blur-lg rounded-2xl shadow-2xl border border-white/10">
            <div class="flex gap-0.5">
              <form hx-post="{{host}}/post/{{$postID}}/react" hx-target="#post-{{$postID}}" hx-swap="outerHTML" class="contents">
                <input type="hidden" name="emoji" value="thumbsup">
                <button type="submit" class="btn btn-ghost btn-sm btn-square text-lg hover:scale-125 hover:bg-transparent transition-transform">üëç</button>
              </form>
              <form hx-post="{{host}}/post/{{$postID}}/react" hx-target="#post-{{$postID}}" hx-swap="outerHTML" class="contents">
                <input type="hidden" name="emoji" value="heart">
                <button type="submit" class="btn btn-ghost btn-sm btn-square text-lg hover:scale-125 hover:bg-transparent transition-transform">‚ù§Ô∏è</button>
              </form>
              <form hx-post="{{host}}/post/{{$postID}}/react" hx-target="#post-{{$postID}}" hx-swap="outerHTML" class="contents">
                <input type="hidden" name="emoji" value="tada">
                <button type="submit" class="btn btn-ghost btn-sm btn-square text-lg hover:scale-125 hover:bg-transparent transition-transform">üéâ</button>
              </form>
              <form hx-post="{{host}}/post/{{$postID}}/react" hx-target="#post-{{$postID}}" hx-swap="outerHTML" class="contents">
                <input type="hidden" name="emoji" value="smile">
                <button type="submit" class="btn btn-ghost btn-sm btn-square text-lg hover:scale-125 hover:bg-transparent transition-transform">üòÑ</button>
              </form>
              <form hx-post="{{host}}/post/{{$postID}}/react" hx-target="#post-{{$postID}}" hx-swap="outerHTML" class="contents">
                <input type="hidden" name="emoji" value="confused">
                <button type="submit" class="btn btn-ghost btn-sm btn-square text-lg hover:scale-125 hover:bg-transparent transition-transform">üòï</button>
              </form>
              <form hx-post="{{host}}/post/{{$postID}}/react" hx-target="#post-{{$postID}}" hx-swap="outerHTML" class="contents">
                <input type="hidden" name="emoji" value="rocket">
                <button type="submit" class="btn btn-ghost btn-sm btn-square text-lg hover:scale-125 hover:bg-transparent transition-transform">üöÄ</button>
              </form>
            </div>
            {{if $userReaction}}
            <div class="border-t border-white/10 mt-2 pt-2">
              <form hx-delete="{{host}}/post/{{$postID}}/react" hx-target="#post-{{$postID}}" hx-swap="outerHTML">
                <button type="submit" class="btn btn-ghost btn-xs btn-block text-error/70 hover:text-error">Remove</button>
              </form>
            </div>
            {{end}}
          </div>
        </div>

        <!-- Comment toggle -->
        <button class="btn btn-ghost btn-sm gap-2 text-white/50 hover:text-white hover:bg-white/5"
          _="on click toggle .hidden on #comments-{{$postID}} then if #comments-{{$postID}} is not .hidden then focus() the first <input/> in #comments-{{$postID}}">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
          </svg>
          <span class="text-xs">{{.CommentsCount}}</span>
        </button>

        <!-- Share button -->
        <button class="btn btn-ghost btn-sm gap-2 text-white/50 hover:text-white hover:bg-white/5 ml-auto"
          _="on click writeText('{{host}}/post/{{$postID}}') into navigator.clipboard then add .tooltip .tooltip-open .tooltip-success to me set my @data-tip to 'Copied!' wait 1.5s remove .tooltip .tooltip-open .tooltip-success from me">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/>
          </svg>
        </button>
      </div>
      {{end}}

      <!-- Comments section -->
      <div id="comments-{{$postID}}" class="hidden mt-4 space-y-3">
        {{if .Comments}}
        <div class="space-y-3 max-h-64 overflow-y-auto">
          {{range .Comments}}
          {{$comment := .}}
          <div class="flex gap-3 p-3 rounded-xl bg-white/[0.02] border border-white/[0.04]">
            {{with .User}}
            <a href="{{host}}/user/{{.Handle}}" class="shrink-0" hx-boost="true">
              <div class="w-8 h-8 rounded-full bg-white/10 border border-white/10 p-0.5">
                <img src="{{.Avatar}}" alt="{{.Name}}" class="w-full h-full rounded-full object-cover">
              </div>
            </a>
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2 mb-1">
                <a href="{{host}}/user/{{.Handle}}" class="text-sm font-medium hover:text-primary transition-colors" hx-boost="true">@{{.Handle}}</a>
              </div>
              <p class="text-sm text-white/70 leading-relaxed">{{$comment.Content}}</p>
            </div>
            {{end}}
          </div>
          {{end}}
        </div>
        {{end}}

        <!-- Comment form -->
        {{if $user}}
        <form hx-post="{{host}}/comment" hx-swap="none" class="flex gap-2"
          _="on htmx:afterRequest reset() me">
          <input type="hidden" name="subject_id" value="{{$postID}}">
          <input type="hidden" name="subject_type" value="post">
          <input type="text" name="content" placeholder="Write a comment..." required
            class="input input-sm flex-1 bg-white/5 border-white/10 focus:border-primary/50 focus:bg-white/[0.08] placeholder:text-white/30 transition-all">
          <button type="submit" class="btn btn-sm btn-primary px-4">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
            </svg>
          </button>
        </form>
        {{end}}
      </div>
    </footer>
  </div>
</article>
