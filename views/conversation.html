<html data-theme="{{theme}}">

<head>
  {{template "includes.html"}}
  <script>
    // Sync unread count after viewing conversation (messages marked as read)
    // This ensures the notification baseline is updated
    (async function() {
      try {
        const resp = await fetch('/api/messages/unread', { credentials: 'same-origin' });
        if (resp.ok) {
          const data = await resp.json();
          window.Skyscape.setLastUnreadCount(data.count || 0);
          console.log('[Conversation] Synced unread count:', data.count);
        }
      } catch (err) {
        console.warn('[Conversation] Failed to sync count:', err);
      }
    })();
  </script>
</head>

<body>
  {{template "layout/start"}}

  {{with $profile := profile.CurrentProfile}}
  <div class="flex flex-col w-full mx-auto -mb-40 md:mb-0 h-[calc(100vh-6rem)] md:h-screen">
    <!-- Header -->
    <div class="w-full p-4 md:p-6 border-b border-white/10 flex-shrink-0" hx-boost="true">
      <div class="w-full max-w-screen-lg mx-auto flex items-center gap-3">
        <!-- Back Chevron -->
        <a href="{{host}}/messages" class="btn btn-ghost btn-sm">
          <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 320 512" height="1em" width="1em"
            xmlns="http://www.w3.org/2000/svg">
            <path
              d="M34.52 239.03L228.87 44.69c9.37-9.37 24.57-9.37 33.94 0l22.67 22.67c9.36 9.36 9.37 24.52.04 33.9L131.49 256l154.02 154.75c9.34 9.38 9.32 24.54-.04 33.9l-22.67 22.67c-9.37 9.37-24.57 9.37-33.94 0L34.52 272.97c-9.37-9.37-9.37-24.57 0-33.94z">
            </path>
          </svg>
        </a>

        <!-- Profile Info -->
        <a href="{{host}}/user/{{$profile.Handle}}" class="flex items-center gap-3 hover:opacity-80 transition-opacity">
          <div class="avatar">
            <div class="w-10 p-0.5 bg-white/10 rounded-full border border-white/10">
              <img src="{{$profile.Avatar}}" alt="{{$profile.Name}}" class="rounded-full">
            </div>
          </div>
          <div>
            <h1 class="text-xl font-bold">{{$profile.Name}}</h1>
            <span class="text-sm opacity-60">@{{$profile.Handle}}</span>
          </div>
        </a>
      </div>
    </div>

    <!-- Messages Container -->
    <div id="messages-container"
      class="w-full max-w-screen-lg mx-auto flex-1 overflow-y-auto flex flex-col-reverse gap-4 px-4 md:px-6 py-4">
      {{if gt messages.Count 0}}

      {{template "message-list.html" messages.Messages}}

      {{else}}
      <div class="flex items-center justify-center h-full">
        <div class="text-center">
          <p class="text-lg opacity-60">No messages yet</p>
          <p class="text-sm opacity-40 mt-2">Start the conversation!</p>
        </div>
      </div>
      {{end}}
    </div>

    <!-- Message Input -->
    <div class="w-full border-t border-white/10 p-4 md:p-6 bg-base-100 flex-shrink-0 md:pr-30">
      <form class="w-full max-w-screen-lg items-center mx-auto flex gap-3"
        hx-post="{{host}}/messages/{{$profile.Handle}}" hx-target="#messages-container" hx-swap="afterbegin"
        _="on htmx:afterRequest set #message-input.value to ''">
        <input type="hidden" name="id" value="{{$profile.ID}}">
        <textarea id="message-input" name="content" autofocus
          class="textarea textarea-bordered flex-1 min-h-14 max-h-32 resize-none" placeholder="Type your message..."
          required></textarea>
        <button type="submit" class="btn btn-lg btn-primary self-end">
          Send
        </button>
      </form>
    </div>
  </div>

  {{else}}
  <div class="p-4 md:py-8 w-full max-w-screen-md mx-auto">
    <div class="card bg-base-100 shadow-lg">
      <div class="card-body text-center">
        <h2 class="card-title text-error">Profile Not Found</h2>
        <p class="opacity-60">The user you're trying to message doesn't exist.</p>
        <a href="{{host}}/messages" class="btn btn-primary mt-4">Back to Messages</a>
      </div>
    </div>
  </div>
  {{end}}

  {{template "layout/end"}}
</body>

</html>