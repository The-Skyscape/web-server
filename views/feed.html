<html data-theme="{{theme}}">

<head>
  {{template "includes.html"}}

</head>

<body>
  {{template "layout/start"}}

  <div class="relative bg-[url('{{host}}/public/background.png')] bg-cover bg-center border-b border-white/10 w-full">
    <div class="absolute inset-0 bg-gradient-to-b from-black/50 to-black/30"></div>
    <div class="relative flex flex-col gap-2 items-center px-4 py-12">
      <h1 class="text-3xl md:text-4xl font-bold tracking-wide text-white/90">What's Happening</h1>
      <p class="text-lg md:text-xl text-white/60 text-center max-w-lg">Get a live feed of what is going on in The Skyscape Community.</p>
    </div>
  </div>

  <div class="p-4 md:py-8 w-full max-w-screen-md mx-auto flex flex-col gap-4">
    {{with $user := auth.CurrentUser}}
    <div class="flex flex-col gap-4 pb-2 -mb-2">
      <div class="flex items-center justify-between gap-2">
        <div class="flex items-center gap-2">
          <div class="avatar flex-shrink-0">
            <div class="w-5 p-0.5 rounded-full bg-white/10 border border-white/10">
              <img src="{{$user.Avatar}}" alt="{{$user.Name}}" class="rounded-full">
            </div>
          </div>
          <span class="text-sm font-semibold opacity-60">
            Post as <span class="opacity-100">@{{$user.Handle}}</span> to The Skyscape
          </span>
        </div>
        <button type="submit" form="post-form" class="btn btn-primary btn-xs" disabled _="on input from #post-content
             if #post-content.value.trim() is not ''
               remove [@disabled] from me
             else
               add [@disabled] to me
             end">
          Post
        </button>
      </div>
      <form id="post-form" class="flex flex-col w-full gap-2" hx-post="{{host}}/feed/post" hx-target=".error" hx-encoding="multipart/form-data">
        <textarea id="post-content" required name="content" class="textarea w-full min-h-24"
          placeholder="What's on your mind, {{$user.Name}}?"></textarea>
        <div class="flex items-center gap-2 flex-wrap">
          <!-- Repo selector -->
          {{$repos := feed.MyRepos}}
          {{if $repos}}
          <select name="repo_id" class="select select-bordered select-sm w-auto">
            <option value="">Promote a Repo</option>
            {{range $repos}}
            <option value="{{.ID}}">{{.Name}}</option>
            {{end}}
          </select>
          {{end}}
          <!-- App selector -->
          {{$apps := feed.MyApps}}
          {{if $apps}}
          <select name="app_id" class="select select-bordered select-sm w-auto">
            <option value="">Promote an App</option>
            {{range $apps}}
            <option value="{{.ID}}">{{.Name}}</option>
            {{end}}
          </select>
          {{end}}
          <!-- Image upload -->
          <label class="btn btn-ghost btn-sm gap-1">
            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
              <circle cx="8.5" cy="8.5" r="1.5"></circle>
              <polyline points="21 15 16 10 5 21"></polyline>
            </svg>
            <span class="hidden sm:inline">Image</span>
            <input type="file" name="image" accept="image/*" class="hidden" _="on change
              if my.files.length > 0
                set my.parentElement.classList to 'btn btn-ghost btn-sm gap-1 btn-active'
              else
                set my.parentElement.classList to 'btn btn-ghost btn-sm gap-1'
              end">
          </label>
        </div>
        <div class="error"></div>
      </form>
    </div>
    {{end}}

    <div id="feed" class="flex flex-col gap-4">
      <!-- Real-time feed polling -->
      <div id="feed-poll"
        hx-get="{{host}}/feed/poll?after={{now.Unix}}"
        hx-trigger="every 5s" hx-target="#feed" hx-swap="afterbegin">
      </div>

      {{$limit := feed.Limit}}
      {{$nextPage := feed.NextPage}}
      {{$activities := feed.RecentActivities}}
      {{if $activities}}
      {{range $index, $activity := $activities}}
      {{if eq (mod (add $index 1) $limit) 0}}
      <div hx-get="{{host}}/?page={{$nextPage}}&limit={{$limit}}" hx-trigger="revealed" hx-swap="afterend"
        hx-select="#feed > *">
        {{template "feed-post.html" $activity}}
      </div>
      {{else}}
      {{template "feed-post.html" $activity}}
      {{end}}
      {{end}}
      {{else}}
      <div class="text-center py-12 opacity-60">
        <p class="text-lg mb-2">No activity yet.</p>
        <p>Create a repo or launch an app to get started!</p>
      </div>
      {{end}}
    </div>
  </div>

  {{template "layout/end"}}
</body>

</html>