<html data-theme="{{theme}}">

<head>
  {{template "includes.html"}}
</head>

<body>
  {{template "layout/start"}}

  <div class="relative bg-[url('{{host}}/public/background.png')] bg-cover bg-center border-b-2 border-white/40 w-full">
    <div class="absolute inset-0 bg-black opacity-40"></div>
    <div class='flex flex-col gap-3 items-center px-4 py-18'>
      <h1 class="text-3xl md:text-4xl font-bold tracking-wide opacity-80">Messages</h1>
      <span class="text-lg md:text-xl font-bold opacity-60 text-center">
        Your conversations with other developers
      </span>
    </div>
  </div>

  <div class="w-full max-w-screen-lg mx-auto -mb-40 md:mb-0">
    <div class="px-6 py-8 flex flex-col gap-3" hx-boost="true">

    <!-- Notification Permission Prompt -->
    <div id="notification-prompt" data-init="notification-prompt" class="alert alert-info hidden">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
      </svg>
      <span>Get notified when you receive new messages</span>
      <div class="flex gap-2">
        <button class="btn btn-sm btn-primary"
                onclick="Skyscape.requestNotifications().then(() => this.closest('.alert').classList.add('hidden'))">
          Enable
        </button>
        <button class="btn btn-sm btn-ghost"
                onclick="localStorage.setItem('notification-prompt-dismissed', Date.now()); this.closest('.alert').classList.add('hidden')">
          Not now
        </button>
      </div>
    </div>
    <script>
      // Register page initializer for notification prompt (works with HTMX navigation)
      Skyscape.onPage('[data-init="notification-prompt"]', (el) => {
        Skyscape.initOnce(el, 'notif-prompt', () => {
          const dismissed = localStorage.getItem('notification-prompt-dismissed');
          if ('Notification' in window && Notification.permission === 'default' && !dismissed) {
            el.classList.remove('hidden');
          }
        });
      });
    </script>

    {{$currentUser := messages.CurrentUser}}
    {{$conversations := messages.Conversations}}
    {{if $conversations}}
    {{range $conversations}}
    <a href="{{host}}/messages/{{.Handle}}"
      class="card bg-base-200/60 backdrop-blur-sm hover:bg-base-200/80 transition-all duration-200 border border-white/5">
      <div class="card-body p-5">
        <div class="flex items-center gap-4">
          <div class="avatar">
            <div class="w-14 p-0.5 bg-white/10 rounded-full border border-white/20">
              <img src="{{.Avatar}}" alt="{{.Name}}" class="rounded-full">
            </div>
          </div>

          <div class="flex-1 min-w-0">
            <div class="flex items-center gap-2 mb-1">
              <span class="text-base font-bold">{{.Name}}</span>
              <span class="text-sm opacity-60">@{{.Handle}}</span>
              {{$unreadCount := $currentUser.UnreadMessagesFrom .}}
              {{if gt $unreadCount 0}}
              <span class="badge badge-primary badge-sm font-semibold">{{$unreadCount}}</span>
              {{end}}
            </div>

            {{$lastMsg := $currentUser.LastMessage .}}
            <p class="text-sm opacity-70 truncate leading-relaxed">
              {{if $lastMsg}}
              {{$lastMsg.Content}}
              {{else}}
              No messages yet
              {{end}}
            </p>
          </div>

          {{$lastMsgTime := $currentUser.LastMessageAt .}}
          {{if not $lastMsgTime.IsZero}}
          <div class="text-xs opacity-60 self-start">
            {{format $lastMsgTime "Jan 2"}}
          </div>
          {{end}}
        </div>
      </div>
    </a>
    {{end}}
    {{else}}
    <div class="card bg-base-200/40 backdrop-blur-sm border border-white/5">
      <div class="card-body text-center py-12">
        <p class="text-base opacity-60">No messages yet. Start a conversation with another developer!</p>
      </div>
    </div>
    {{end}}
    </div>
  </div>

  {{template "layout/end"}}
</body>

</html>
