<html data-theme="{{theme}}">

<head>
  {{template "includes.html"}}
</head>

<body>
  {{template "layout/start"}}

  <div class="max-w-screen-xl flex flex-col gap-6 w-full mx-auto px-4 py-8 md:py-12 z-20">
    {{with $app := apps.CurrentApp}}
    {{$user := auth.CurrentUser}}
    {{$owner := $app.Owner}}
    {{$repo := $app.Repo}}
    {{$isOwner := and $user $owner (eq $user.ID $owner.ID)}}
    {{$canManage := or $isOwner (and $user $user.IsAdmin)}}

    <!-- Header matching repo-header style -->
    <div class="flex items-center gap-2">
      {{with $owner}}
      <a hx-boost="true" href="{{host}}/user/{{.Handle}}" class="btn btn-ghost text-lg px-2">
        <div class="avatar">
          <div class="w-8 p-1 rounded-full bg-white/10 border border-white/10 shadow">
            <img src="{{.Avatar}}" alt="{{.Name}}" class="rounded-full">
          </div>
        </div>
        <span class="hidden md:inline">@{{.Handle}}</span>
      </a>
      {{end}}

      <span class="text-lg font-bold opacity-80">/</span>

      <span class="text-xl font-semibold">{{$app.Name}}</span>

      <div class="flex items-center gap-2 ml-auto bg-transparent" data-theme="light">
        <a target="_blank" href="https://{{$app.ID}}.skysca.pe" class="btn btn-sm btn-primary shadow-xl hidden md:flex">
          Open App
          <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" height="1em" width="1em"
            xmlns="http://www.w3.org/2000/svg">
            <path fill="none" stroke-linecap="round" stroke-linejoin="round" stroke-width="32"
              d="M384 224v184a40 40 0 0 1-40 40H104a40 40 0 0 1-40-40V168a40 40 0 0 1 40-40h167.48M336 64h112v112M224 288 440 72">
            </path>
          </svg>
        </a>
      </div>

      <div class="dropdown dropdown-end">
        <div tabindex="0" role="button" class="btn btn-ghost">
          {{template "icon-dots.html"}}
        </div>
        <ul tabindex="-1"
          class="dropdown-content menu bg-base-100 rounded-box z-50 mt-2 w-52 p-2 shadow-sm border border-white/20">
          <li class="md:hidden">
            <a target="_blank" href="https://{{$app.ID}}.skysca.pe">Open App</a>
          </li>
          <li>
            <a _="on click
              call navigator.clipboard.writeText('https://theskyscape.com/app/{{$app.ID}}') then
              set my textContent to 'Copied âœ“' then
              wait 2s then
              set my textContent to 'Copy Link'">
              Copy Link
            </a>
          </li>
          {{if $user}}
          <li><a _="on click call share_app_modal.showModal()">Share to Feed</a></li>
          <li><a _="on click call promote_app_modal.showModal()">Promote</a></li>
          {{end}}
          {{if $canManage}}
          <li><a href="{{host}}/app/{{$app.ID}}/manage" hx-boost="true">Manage</a></li>
          <li><a _="on click call edit_app_modal.showModal()">Edit</a></li>
          <li><a hx-delete="{{host}}/app/{{$app.ID}}" hx-confirm="Are you sure you want to shutdown this app?">Shutdown</a></li>
          {{end}}
        </ul>
      </div>
    </div>

    {{$img := apps.CurrentImage}}

    {{if not $img}}
    <!-- No deployed build yet -->
    {{if $canManage}}
    <!-- Owner view: Show launch history -->
    <div class="flex flex-col gap-6 w-full max-w-screen-lg mx-auto">
      <div class="card bg-base-100/80 backdrop-blur-sm border border-white/5 shadow-lg">
        <div class="card-body text-center py-8">
          <div class="w-16 h-16 rounded-full bg-warning/10 flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-warning" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
          </div>
          <h2 class="text-xl font-semibold mb-2">App Not Yet Deployed</h2>
          <p class="opacity-60 max-w-md mx-auto">Your app is being built. Once the build completes, it will be automatically deployed.</p>
        </div>
      </div>

      <!-- Launch History for owner -->
      <div class="flex flex-col gap-4">
        <div class="flex items-center justify-between py-2">
          <h3 class="font-semibold text-lg">Launch History</h3>
          <div class="flex items-center gap-2">
            <span class="htmx-indicator loading loading-spinner loading-xs"></span>
            <button class="btn btn-sm btn-primary" hx-post="{{host}}/app/{{$app.ID}}/launch">
              Launch New Version
            </button>
          </div>
        </div>
        {{template "app-versions.html" $app}}
      </div>
    </div>
    {{else}}
    <!-- Non-owner view: Under construction -->
    <div class="flex flex-col items-center justify-center py-16 text-center w-full">
      <div class="w-20 h-20 rounded-full bg-warning/10 flex items-center justify-center mb-6">
        <svg class="w-10 h-10 text-warning" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/>
        </svg>
      </div>
      <h2 class="text-2xl font-bold text-white/90 mb-3">Under Construction</h2>
      <p class="text-white/60 max-w-md mb-6">This app is currently being set up by the developer. Check back soon!</p>
      {{with $owner}}
      <a href="{{host}}/user/{{.Handle}}" class="btn btn-ghost" hx-boost="true">
        <div class="avatar">
          <div class="w-6 rounded-full">
            <img src="{{.Avatar}}" alt="{{.Name}}">
          </div>
        </div>
        View @{{.Handle}}'s profile
      </a>
      {{end}}
    </div>
    {{end}}
    {{else}}

    <!-- Two-column layout -->
    <div class="flex flex-col md:flex-row justify-between gap-8 w-full">
      <!-- Left column: Preview, About, Repo README -->
      <div class="flex flex-col gap-4 w-full max-w-screen-md">
        <!-- App Preview -->
        <div class="card relative w-full aspect-video rounded-box overflow-hidden bg-base-100 shadow-lg border border-white/5">
          <img src="https://apps.skysca.pe/{{$app.ID}}" class="absolute inset-0 z-10 w-full h-full object-cover">
          <a target="_blank" href="https://{{$app.ID}}.skysca.pe" class="bg-black/40 inset-0 absolute z-20 flex opacity-0 hover:opacity-100 transition-opacity">
            <div class="btn btn-lg btn-primary opacity-90 m-auto">
              Visit App
              <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" height="1em" width="1em"
                xmlns="http://www.w3.org/2000/svg">
                <path fill="none" stroke-linecap="round" stroke-linejoin="round" stroke-width="32"
                  d="M384 224v184a40 40 0 0 1-40 40H104a40 40 0 0 1-40-40V168a40 40 0 0 1 40-40h167.48M336 64h112v112M224 288 440 72">
                </path>
              </svg>
            </div>
          </a>
        </div>

        <!-- CTA Buttons -->
        {{template "app-cta-buttons.html" $app}}

        <!-- About section -->
        <div class="card bg-base-100 w-full shadow-lg border border-white/5">
          <div class="card-body">
            <h2 class="card-title text-lg">About This App</h2>
            <p class="text-sm opacity-80 leading-relaxed">
              {{$app.Description}}
            </p>
          </div>
        </div>

        <!-- Source Repo Link -->
        {{if and $owner $repo}}
        <a href="{{host}}/repo/{{$repo.ID}}" class="flex items-center justify-between p-4 rounded-lg bg-base-200 hover:bg-base-300 transition" hx-boost="true">
          <div class="flex items-center gap-3">
            <div class="flex items-center justify-center w-8 h-8 rounded-full bg-secondary/20 text-secondary shrink-0">
              <svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="1.2em" width="1.2em" xmlns="http://www.w3.org/2000/svg">
                <path d="M11 21.73a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73z"></path>
                <path d="M12 22V12"></path>
                <path d="m3.3 7 7.703 4.734a2 2 0 0 0 1.994 0L20.7 7"></path>
                <path d="m7.5 4.27 9 5.15"></path>
              </svg>
            </div>
            <div class="flex flex-col">
              <span class="text-xs opacity-60">Source Code</span>
              <span class="font-medium">@{{$owner.Handle}} / {{$repo.Name}}</span>
            </div>
          </div>
          {{template "icon-chevron-right.html"}}
        </a>

        <!-- README Preview -->
        {{with apps.ReadmeFile}}
        <div class="card bg-base-100 w-full shadow-lg border border-white/5">
          <div class="card-body">
            <div class="markdown">{{.Read.Markdown}}</div>
          </div>
        </div>
        {{end}}
        {{end}}
      </div>

      <!-- Right column: Sidebar info + Comments -->
      <div class="flex flex-col gap-4 px-2 w-full md:max-w-108">
        <!-- Active Skyscapers -->
        <div class="flex flex-col gap-2">
          <label class="text-xs font-bold opacity-60 tracking-wider">
            Active Skyscapers
          </label>

          {{$auths := apps.AuthorizedUsers}}
          {{$count := len $auths}}
          {{if $auths}}
          <div class="flex items-center gap-3">
            <div class="avatar-group -space-x-4">
              {{range $i, $auth := $auths}}
              {{if lt $i 6}}
              {{with $authUser := $auth.User}}
              <a href="{{host}}/user/{{$authUser.Handle}}" class="avatar" hx-boost="true" title="@{{$authUser.Handle}}">
                <div class="w-10 rounded-full border-2 border-base-100">
                  <img src="{{$authUser.Avatar}}" alt="{{$authUser.Name}}">
                </div>
              </a>
              {{end}}
              {{end}}
              {{end}}
              {{if gt $count 6}}
              <div class="avatar placeholder">
                <div class="bg-neutral text-neutral-content w-10 rounded-full border-2 border-base-100">
                  <span>+{{sub $count 6}}</span>
                </div>
              </div>
              {{end}}
            </div>
            <span class="text-sm opacity-60">
              {{$count}} Skyscaper{{if gt $count 1}}s{{end}}
            </span>
          </div>
          {{else}}
          <div class="px-3 text-sm opacity-60">
            No active users yet
          </div>
          {{end}}
        </div>

        <!-- Current Version -->
        <div class="flex flex-col gap-2">
          <label class="text-xs font-bold opacity-60 tracking-wider">
            Current Version
          </label>
          {{if $isOwner}}
          <a href="{{host}}/app/{{$app.ID}}/manage" class="flex items-center justify-between p-2 rounded-lg bg-base-200 hover:bg-base-300 transition cursor-pointer" hx-boost="true">
            <div class="flex items-center gap-2">
              <span class="badge badge-success badge-sm">Running</span>
              <span class="font-mono text-sm opacity-80">{{slice $img.GitHash 0 7}}</span>
              <span class="text-sm opacity-60">{{timeAgo $img.CreatedAt}}</span>
            </div>
            {{template "icon-chevron-right.html"}}
          </a>
          {{else}}
          <div class="flex items-center p-2 rounded-lg bg-base-200">
            <div class="flex items-center gap-2">
              <span class="badge badge-success badge-sm">Running</span>
              <span class="font-mono text-sm opacity-80">{{slice $img.GitHash 0 7}}</span>
              <span class="text-sm opacity-60">{{timeAgo $img.CreatedAt}}</span>
            </div>
          </div>
          {{end}}
        </div>

        <!-- Comments Section -->
        <div class="flex flex-col gap-2">
          <label class="text-xs font-bold opacity-60 tracking-wider">
            Comments
          </label>

          {{with $user}}
          <form class="flex flex-col w-full" hx-post="{{host}}/comment" hx-target=".comment-error" hx-swap="innerHTML">
            <input type="hidden" name="subject_id" value="{{$app.ID}}">
            <input type="hidden" name="subject_type" value="app">
            <textarea required name="content" class="textarea w-full"
              placeholder="Leave a comment about this app..."></textarea>
            <div class="flex items-center justify-between px-4 pt-2">
              <span class="text-sm font-semibold opacity-60">
                @{{.Handle}}
              </span>
              <button class="btn btn-sm btn-secondary">
                Post
              </button>
            </div>
            <div class="comment-error"></div>
          </form>
          {{else}}
          <div class="flex items-center justify-between gap-4 p-3 rounded-box bg-base-200 text-sm" hx-boost="true">
            <span class="opacity-70">Sign in to leave a comment</span>
            <a href="{{host}}/signin?next=/app/{{$app.ID}}" class="btn btn-sm btn-ghost">Sign In</a>
          </div>
          {{end}}

          <div id="app-comments" class="flex flex-col">
            {{$comments := apps.Comments}}
            {{$limit := apps.CommentLimit}}
            {{$nextPage := apps.CommentNextPage}}
            {{if $comments}}
            {{range $index, $comment := $comments}}
            {{if eq (mod (add $index 1) $limit) 0}}
            <div hx-get="{{host}}/app/{{$app.ID}}/comments?page={{$nextPage}}&limit={{$limit}}" hx-trigger="revealed" hx-swap="afterend"
              hx-select="#app-comments > *">
              {{template "app-comment.html" $comment}}
            </div>
            {{else}}
            {{template "app-comment.html" $comment}}
            {{end}}
            {{end}}
            {{else}}
            <div class="text-center py-8 text-sm opacity-60">
              No comments yet. Be the first to share your thoughts!
            </div>
            {{end}}
          </div>
        </div>
      </div>
    </div>
    {{end}}

    {{template "share-app-modal.html" $app}}
    {{template "promote-app-modal.html" $app}}
    {{template "oauth-secret-modal.html" $app}}
    {{template "edit-app-modal.html" $app}}
    {{else}}
    <h1 class="text-2xl font-semibold">App not found</h1>
    {{end}}
  </div>

  {{template "layout/end"}}
</body>

</html>
