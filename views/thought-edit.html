<html data-theme="{{theme}}">

<head>
  {{template "includes.html"}}
  <title>{{if thoughts.CurrentThought}}Edit{{else}}New{{end}} Thought | The Skyscape</title>
  <style>
    .block-content:empty:before {
      content: attr(data-placeholder);
      color: rgba(255, 255, 255, 0.3);
      pointer-events: none;
    }
    .block-content:focus {
      outline: none;
    }
    .editor-block:hover .block-handle {
      opacity: 0.6;
    }
  </style>
</head>

<body>
  {{template "layout/start"}}

  {{$thought := thoughts.CurrentThought}}
  {{$isEdit := ne $thought nil}}
  {{$user := auth.CurrentUser}}

  <div class="max-w-screen-md w-full mx-auto px-4 py-8 md:py-12">
    <!-- Header -->
    <div class="flex items-center justify-between mb-8">
      <h1 class="text-2xl font-bold">{{if $isEdit}}Edit Thought{{else}}New Thought{{end}}</h1>
      <div id="save-indicator" class="text-xs text-white/40 opacity-0 transition-opacity">Saved</div>
    </div>

    <div class="error-message text-center text-error mb-4" role="alert" aria-live="polite"></div>

    {{if $isEdit}}
    <!-- Block-based editor for existing thoughts -->
    <div id="thought-editor">

      <!-- Header image -->
      <div id="header-image" class="relative mb-6 rounded-xl overflow-hidden group">
        <img src="{{host}}{{$thought.HeaderImage}}" alt="Header" class="w-full h-48 object-cover">
        <label class="absolute inset-0 flex items-center justify-center bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer">
          <span class="btn btn-ghost btn-sm text-white">Change header image</span>
          <input type="file" name="file" accept="image/*" class="hidden"
            hx-post="{{host}}/thought/{{$thought.ID}}/header"
            hx-trigger="change"
            hx-target="#header-image"
            hx-swap="outerHTML"
            hx-encoding="multipart/form-data">
        </label>
      </div>

      <!-- Title input with auto-save -->
      <input required name="title" type="text"
        class="input input-lg input-ghost w-full text-3xl font-bold px-0 focus:outline-none mb-6"
        placeholder="Title" value="{{$thought.Title}}"
        hx-post="{{host}}/thought/{{$thought.ID}}"
        hx-trigger="input changed delay:1s"
        hx-vals='{"published": "{{$thought.Published}}"}'
        hx-swap="none"
        _="on htmx:afterRequest
           put 'Saved' into #save-indicator
           add .opacity-100 to #save-indicator
           wait 1s
           remove .opacity-100 from #save-indicator">

      <!-- Block editor area -->
      <div id="editor-blocks" class="flex flex-col gap-1 min-h-96">
        {{range $thought.Blocks}}
        {{template "editor-block.html" .}}
        {{end}}

        <!-- Add block buttons -->
        <div id="add-block-buttons" class="flex gap-2 mt-4">
          <button type="button" class="btn btn-ghost btn-sm opacity-40 hover:opacity-100"
            hx-post="{{host}}/thought/{{$thought.ID}}/blocks"
            hx-vals='{"type": "paragraph"}'
            hx-target="#add-block-buttons"
            hx-swap="beforebegin">
            + Text
          </button>
          <label class="btn btn-ghost btn-sm opacity-40 hover:opacity-100 cursor-pointer">
            + Image
            <input type="file" name="file" accept="image/*" class="hidden"
              hx-post="{{host}}/thought/{{$thought.ID}}/blocks/image"
              hx-trigger="change"
              hx-target="#add-block-buttons"
              hx-swap="beforebegin"
              hx-encoding="multipart/form-data"
              _="on htmx:afterRequest set my.value to ''">
          </label>
        </div>
      </div>

      <!-- Actions -->
      <div class="flex items-center gap-4 mt-8 pt-6 border-t border-white/10">
        <label class="flex items-center gap-2 cursor-pointer">
          <input type="checkbox" name="published" class="checkbox checkbox-primary"
            {{if $thought.Published}}checked{{end}}
            hx-post="{{host}}/thought/{{$thought.ID}}"
            hx-include="[name=title]"
            hx-vals='js:{"published": event.target.checked ? "true" : "false"}'
            hx-swap="none">
          <span class="text-sm">Published</span>
        </label>

        <div class="ml-auto flex items-center gap-4">
          <a href="{{host}}/thought/{{$thought.ID}}" class="btn btn-ghost" hx-boost="true">View</a>
          <button type="button" class="btn btn-error btn-outline"
            hx-delete="{{host}}/thought/{{$thought.ID}}"
            hx-confirm="Are you sure you want to delete this thought?">Delete</button>
        </div>
      </div>
    </div>

    {{else}}
    <!-- Simple form for new thoughts (creates thought first, then redirects to editor) -->
    <form hx-post="{{host}}/thoughts" hx-target="previous .error-message" hx-swap="innerHTML"
      class="flex flex-col gap-6">

      <label class="floating-label">
        <input required name="title" type="text" class="input input-lg w-full" placeholder="Title">
        <span>Title</span>
      </label>

      <p class="text-sm text-white/50">
        Start with a title. After creating, you'll be taken to the full editor where you can add
        text, images, code blocks, and more.
      </p>

      <input type="hidden" name="content" value="">
      <input type="hidden" name="published" value="false">

      <div class="flex items-center gap-4 mt-4">
        <button type="submit" class="btn btn-primary">Create & Edit</button>
        <a href="{{host}}/thoughts" class="btn btn-ghost" hx-boost="true">Cancel</a>
      </div>
    </form>
    {{end}}
  </div>

  {{template "layout/end"}}
</body>

</html>
